#### 1 kafka什么情况下丢失数据

1. 生产者丢失数据
2. broker之间同步丢失
3. broker内刷盘丢失

#### 2 如何实现kafka不丢失数据

1. 从kafka拉取消息时（可配置条数）
2. 为每条消息分配一个msgid（递增）
3. 将msgid存入内存队列（sortSet）
4. 使用Map存储msgid与msg（有offset相关的信息）的映射关系
5. 当业务处理完消息后，ack时，获取当前的处理消息的msgid，然后与sortset删除该msgid
6. 接着与sortSet对列的首部第一个id比较（最小的msgid），如果当前msgid《=sortset第一个id，则提交当前offset
7. 系统即便挂了，在下次重启时就会从sortset队首的消息开始拉取，实现至少处理一次的语义
8. 会有少量的消息重复，下游做好幂等

#### 3 顺序消费

1. 宽表：将每⼀个订单状态，单独分出⼀个或多个独⽴的字段。消息来时只更新对应的字段就好，消息只会存在短暂的状态不⼀致问题，但是状态最终是⼀致的

2. 消息补偿机制：另⼀个进⾏消费相同topic的数据，消息落盘，延迟处理。将消息与DB进⾏对⽐，如

   果发现数据不⼀致，再重新发送消息⾄主进程处理



单个分区消费： 创建一个单独的消费者实例来消费一个分区的消息。这样可以确保在单个分区内的消息按顺序消费。但是需要注意，如果有多个分区，不同分区的消息仍可能以并发方式进行消费

指定分区消费：通过指定消费者订阅的特定分区，可以确保只消费指定分区的消息。这样，可以通过将相关消息发送到同一个分区来保证消息的顺序消费

按键分区：Kafka允许根据消息的键（key）来决定将消息发送到哪个分区。如果消息的键是相同的，Kafka会将它们发送到同一个分区。因此，可以根据消息的键来保证消息的顺序消费